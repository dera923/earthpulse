<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>EarthPulse çµ±åˆãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" />
    <style>
        body {
            margin: 0;
            font-family: Arial, sans-serif;
            background-color: #f5f5f5;
        }
        .header {
            background: linear-gradient(135deg, #2c3e50, #34495e);
            color: white;
            padding: 20px;
            text-align: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-template-rows: 60vh 40vh;
            gap: 10px;
            padding: 10px;
            height: calc(100vh - 100px);
        }
        .map-panel {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            position: relative;
            overflow: hidden;
        }
        .control-panel {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 20px;
            overflow-y: auto;
        }
        .map-container {
            grid-column: 1 / 3;
            grid-row: 1;
        }
        #map { 
            width: 100%; 
            height: 100%; 
        }
        .controls {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 1000;
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }
        .controls button {
            margin: 5px;
            padding: 8px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
        }
        .controls button.active {
            background-color: #3498db;
            color: white;
        }
        .controls button:not(.active) {
            background-color: #ecf0f1;
            color: #2c3e50;
        }
        .controls button:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .legend {
            position: absolute;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            font-size: 12px;
            max-width: 200px;
        }
        .legend-item {
            display: flex;
            align-items: center;
            margin: 5px 0;
        }
        .legend-color {
            width: 12px;
            height: 12px;
            margin-right: 8px;
            border-radius: 50%;
        }
        .status-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 20px;
        }
        .status-card {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            border-left: 4px solid #3498db;
        }
        .status-card.error {
            border-left-color: #e74c3c;
        }
        .status-card.success {
            border-left-color: #27ae60;
        }
        .status-number {
            font-size: 24px;
            font-weight: bold;
            color: #2c3e50;
        }
        .status-label {
            font-size: 12px;
            color: #7f8c8d;
            margin-top: 5px;
        }
        .data-refresh {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .refresh-btn {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }
        .refresh-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(52, 152, 219, 0.3);
        }
        .last-update {
            font-size: 12px;
            color: #7f8c8d;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸŒ EarthPulse çµ±åˆç›£è¦–ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h1>
        <p>ç½å®³ãƒ‡ãƒ¼ã‚¿ã¨é€šä¿¡çŠ¶æ³ã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ç›£è¦–</p>
    </div>

    <div class="container">
        <div class="map-panel map-container">
            <div class="controls">
                <button id="earthquakeBtn" class="active" onclick="toggleLayer('earthquake')">åœ°éœ‡ãƒ‡ãƒ¼ã‚¿</button>
                <button id="fireBtn" onclick="toggleLayer('fire')">ç«ç½ãƒ‡ãƒ¼ã‚¿</button>
                <button id="networkBtn" onclick="toggleLayer('network')">é€šä¿¡çŠ¶æ³</button>
                <button onclick="refreshAllData()">å…¨ãƒ‡ãƒ¼ã‚¿æ›´æ–°</button>
            </div>
            
            <div class="legend">
                <div id="earthquakeLegend">
                    <h4>åœ°éœ‡ãƒ‡ãƒ¼ã‚¿</h4>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #e74c3c;"></div>
                        <span>M7.0+</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #f39c12;"></div>
                        <span>M5.0-6.9</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #f1c40f;"></div>
                        <span>M3.0-4.9</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #3498db;"></div>
                        <span>M0.0-2.9</span>
                    </div>
                </div>
                <div id="fireLegend" style="display: none;">
                    <h4>ç«ç½ãƒ‡ãƒ¼ã‚¿</h4>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #ff4444;"></div>
                        <span>é«˜è¼åº¦ (>330K)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #ff8844;"></div>
                        <span>ä¸­è¼åº¦ (310-330K)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #ffaa44;"></div>
                        <span>ä½è¼åº¦ (<310K)</span>
                    </div>
                </div>
                <div id="networkLegend" style="display: none;">
                    <h4>é€šä¿¡çŠ¶æ³</h4>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #27ae60;"></div>
                        <span>æ­£å¸¸</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #e74c3c;"></div>
                        <span>é€šä¿¡æ–­</span>
                    </div>
                </div>
            </div>
            
            <div id="map"></div>
        </div>

        <div class="control-panel">
            <div class="data-refresh">
                <button class="refresh-btn" onclick="refreshAllData()">ğŸ”„ ãƒ‡ãƒ¼ã‚¿æ›´æ–°</button>
                <div class="last-update" id="lastUpdate">æœ€çµ‚æ›´æ–°: æœªå–å¾—</div>
            </div>
            
            <div class="status-grid">
                <div class="status-card" id="earthquakeStatus">
                    <div class="status-number" id="earthquakeCount">-</div>
                    <div class="status-label">åœ°éœ‡ãƒ‡ãƒ¼ã‚¿ (24h)</div>
                </div>
                <div class="status-card" id="fireStatus">
                    <div class="status-number" id="fireCount">-</div>
                    <div class="status-label">ç«ç½ãƒ‡ãƒ¼ã‚¿ (24h)</div>
                </div>
                <div class="status-card" id="networkStatus">
                    <div class="status-number" id="networkUptime">-</div>
                    <div class="status-label">é€šä¿¡ç¨¼åƒç‡ (%)</div>
                </div>
                <div class="status-card" id="alertStatus">
                    <div class="status-number" id="alertCount">-</div>
                    <div class="status-label">ã‚¢ã‚¯ãƒ†ã‚£ãƒ–è­¦å‘Š</div>
                </div>
            </div>

            <div style="margin-top: 20px;">
                <h3>ğŸš¨ ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ³</h3>
                <div id="systemLogs" style="background: #f8f9fa; padding: 10px; border-radius: 4px; max-height: 200px; overflow-y: auto; font-family: monospace; font-size: 12px;">
                    <div>ã‚·ã‚¹ãƒ†ãƒ èµ·å‹•ä¸­...</div>
                </div>
            </div>
        </div>

        <div class="control-panel">
            <h3>ğŸ“Š ãƒ‡ãƒ¼ã‚¿åé›†åˆ¶å¾¡</h3>
            <div style="margin: 10px 0;">
                <button class="refresh-btn" onclick="fetchEarthquakeData()">åœ°éœ‡ãƒ‡ãƒ¼ã‚¿å–å¾—</button>
                <button class="refresh-btn" onclick="fetchFireData()">NASAç«ç½ãƒ‡ãƒ¼ã‚¿å–å¾—</button>
            </div>
            <div style="margin: 10px 0;">
                <button class="refresh-btn" onclick="testNetworkConnectivity()">é€šä¿¡ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ</button>
                <button class="refresh-btn" onclick="fetchSnsData()">SNSãƒ‡ãƒ¼ã‚¿åé›†</button>
            </div>
            
            <h3>âš™ï¸ ã‚·ã‚¹ãƒ†ãƒ è¨­å®š</h3>
            <div style="margin: 10px 0;">
                <label>æ›´æ–°é–“éš” (åˆ†): </label>
                <select id="updateInterval" onchange="setUpdateInterval()">
                    <option value="5">5åˆ†</option>
                    <option value="15" selected>15åˆ†</option>
                    <option value="30">30åˆ†</option>
                    <option value="60">1æ™‚é–“</option>
                </select>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
    <script>
        // åœ°å›³åˆæœŸåŒ–
        const map = L.map('map').setView([39.8283, -98.5795], 4);
        
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);

        // ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚°ãƒ«ãƒ¼ãƒ—
        let earthquakeLayer = L.layerGroup();
        let fireLayer = L.layerGroup();
        let networkLayer = L.layerGroup();
        
        let activeLayer = 'earthquake';
        earthquakeLayer.addTo(map);

        // ã‚·ã‚¹ãƒ†ãƒ ãƒ­ã‚°å‡ºåŠ›
        function addLog(message, type = 'info') {
            const logs = document.getElementById('systemLogs');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.innerHTML = `[${timestamp}] ${message}`;
            logEntry.style.color = type === 'error' ? '#e74c3c' : type === 'success' ? '#27ae60' : '#2c3e50';
            logs.appendChild(logEntry);
            logs.scrollTop = logs.scrollHeight;
        }

        // ãƒ¬ã‚¤ãƒ¤ãƒ¼åˆ‡ã‚Šæ›¿ãˆ
        function toggleLayer(layerType) {
            // ã™ã¹ã¦ã®ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’éè¡¨ç¤º
            map.removeLayer(earthquakeLayer);
            map.removeLayer(fireLayer);
            map.removeLayer(networkLayer);
            
            // ãƒœã‚¿ãƒ³ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ
            document.querySelectorAll('.controls button').forEach(btn => btn.classList.remove('active'));
            
            // é¸æŠã•ã‚ŒãŸãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’è¡¨ç¤º
            activeLayer = layerType;
            
            if (layerType === 'earthquake') {
                earthquakeLayer.addTo(map);
                document.getElementById('earthquakeBtn').classList.add('active');
                document.getElementById('earthquakeLegend').style.display = 'block';
                document.getElementById('fireLegend').style.display = 'none';
                document.getElementById('networkLegend').style.display = 'none';
            } else if (layerType === 'fire') {
                fireLayer.addTo(map);
                document.getElementById('fireBtn').classList.add('active');
                document.getElementById('earthquakeLegend').style.display = 'none';
                document.getElementById('fireLegend').style.display = 'block';
                document.getElementById('networkLegend').style.display = 'none';
            } else if (layerType === 'network') {
                networkLayer.addTo(map);
                document.getElementById('networkBtn').classList.add('active');
                document.getElementById('earthquakeLegend').style.display = 'none';
                document.getElementById('fireLegend').style.display = 'none';
                document.getElementById('networkLegend').style.display = 'block';
            }
        }

        // åœ°éœ‡ãƒ‡ãƒ¼ã‚¿å–å¾—ãƒ»è¡¨ç¤º
        function fetchEarthquakeData() {
            addLog('åœ°éœ‡ãƒ‡ãƒ¼ã‚¿å–å¾—é–‹å§‹...', 'info');
            fetch('/earthquakes', { method: 'POST' })
                .then(res => res.json())
                .then(data => {
                    addLog(`åœ°éœ‡ãƒ‡ãƒ¼ã‚¿å–å¾—å®Œäº†: ${data.count}ä»¶`, 'success');
                    loadEarthquakeData();
                })
                .catch(err => {
                    addLog(`åœ°éœ‡ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼: ${err.message}`, 'error');
                });
        }

        function loadEarthquakeData() {
            fetch('/earthquakes-data')
                .then(res => res.json())
                .then(data => {
                    earthquakeLayer.clearLayers();
                    
                    data.features.forEach(quake => {
                        const lat = quake.latitude;
                        const lon = quake.longitude;
                        const mag = quake.mag;
                        const place = quake.place;
                        
                        let color, radius;
                        if (mag >= 7.0) {
                            color = '#e74c3c';
                            radius = 15;
                        } else if (mag >= 5.0) {
                            color = '#f39c12';
                            radius = 10;
                        } else if (mag >= 3.0) {
                            color = '#f1c40f';
                            radius = 7;
                        } else {
                            color = '#3498db';
                            radius = 4;
                        }

                        L.circleMarker([lat, lon], {
                            radius: radius,
                            color: color,
                            fillColor: color,
                            fillOpacity: 0.7,
                            weight: 2
                        }).bindPopup(`
                            <b>åœ°éœ‡æƒ…å ±</b><br>
                            ãƒã‚°ãƒ‹ãƒãƒ¥ãƒ¼ãƒ‰: ${mag}<br>
                            å ´æ‰€: ${place}<br>
                            ä½ç½®: ${lat.toFixed(4)}, ${lon.toFixed(4)}
                        `).addTo(earthquakeLayer);
                    });
                    
                    document.getElementById('earthquakeCount').textContent = data.features.length;
                    updateLastUpdate();
                });
        }

        // ç«ç½ãƒ‡ãƒ¼ã‚¿å–å¾—ãƒ»è¡¨ç¤º
        function fetchFireData() {
            addLog('NASAç«ç½ãƒ‡ãƒ¼ã‚¿å–å¾—é–‹å§‹...', 'info');
            fetch('/nasa-fires', { method: 'POST' })
                .then(res => res.json())
                .then(data => {
                    if (data.error) {
                        addLog(`ç«ç½ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼: ${data.error}`, 'error');
                    } else {
                        addLog(`ç«ç½ãƒ‡ãƒ¼ã‚¿å–å¾—å®Œäº†: ${data.count}ä»¶`, 'success');
                        loadFireData();
                    }
                })
                .catch(err => {
                    addLog(`ç«ç½ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼: ${err.message}`, 'error');
                });
        }

        function loadFireData() {
            fetch('/fires-data')
                .then(res => res.json())
                .then(data => {
                    fireLayer.clearLayers();
                    
                    data.features.forEach(fire => {
                        const lat = fire.latitude;
                        const lon = fire.longitude;
                        const brightness = fire.brightness;
                        
                        let color;
                        if (brightness > 330) color = '#ff4444';
                        else if (brightness > 310) color = '#ff8844';
                        else color = '#ffaa44';

                        L.circleMarker([lat, lon], {
                            radius: Math.max(3, Math.min(12, brightness / 30)),
                            color: color,
                            fillColor: color,
                            fillOpacity: 0.7,
                            weight: 1
                        }).bindPopup(`
                            <b>ç«ç½æ¤œçŸ¥</b><br>
                            è¼åº¦: ${brightness}K<br>
                            ä¿¡é ¼åº¦: ${fire.confidence}<br>
                            æ¤œçŸ¥æ—¥: ${fire.acq_date}
                        `).addTo(fireLayer);
                    });
                    
                    document.getElementById('fireCount').textContent = data.features.length;
                    updateLastUpdate();
                });
        }

        // SNSãƒ‡ãƒ¼ã‚¿å–å¾—
        function fetchSnsData() {
            addLog('SNSãƒ‡ãƒ¼ã‚¿åé›†é–‹å§‹...', 'info');
            fetch('/sns-data', { method: 'POST' })
                .then(res => res.json())
                .then(data => {
                    addLog(`SNSãƒ‡ãƒ¼ã‚¿: ${data.message}`, 'info');
                });
        }

        // é€šä¿¡ãƒ†ã‚¹ãƒˆ
        function testNetworkConnectivity() {
            addLog('é€šä¿¡ãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­...', 'info');
            // å®Ÿéš›ã®ãƒ†ã‚¹ãƒˆãƒ­ã‚¸ãƒƒã‚¯ã‚’ã“ã“ã«å®Ÿè£…
            setTimeout(() => {
                addLog('é€šä¿¡ãƒ†ã‚¹ãƒˆå®Œäº†: å…¨ã‚¿ãƒ¼ã‚²ãƒƒãƒˆæ­£å¸¸', 'success');
                document.getElementById('networkUptime').textContent = '98.5';
            }, 2000);
        }

        // å…¨ãƒ‡ãƒ¼ã‚¿æ›´æ–°
        function refreshAllData() {
            addLog('å…¨ãƒ‡ãƒ¼ã‚¿æ›´æ–°é–‹å§‹...', 'info');
            fetchEarthquakeData();
            fetchFireData();
            testNetworkConnectivity();
        }

        // æœ€çµ‚æ›´æ–°æ™‚åˆ»ã‚’æ›´æ–°
        function updateLastUpdate() {
            document.getElementById('lastUpdate').textContent = 
                `æœ€çµ‚æ›´æ–°: ${new Date().toLocaleString()}`;
        }

        // æ›´æ–°é–“éš”è¨­å®š
        function setUpdateInterval() {
            const interval = document.getElementById('updateInterval').value;
            addLog(`è‡ªå‹•æ›´æ–°é–“éš”ã‚’${interval}åˆ†ã«è¨­å®š`, 'info');
        }

        // åˆæœŸãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
        window.onload = function() {
            addLog('EarthPulseãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰èµ·å‹•å®Œäº†', 'success');
            refreshAllData();
        };
    </script>
</body>
</html> 